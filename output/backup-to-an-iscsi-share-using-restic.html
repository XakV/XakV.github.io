<!DOCTYPE html>
<html lang="en">
<head>
          <title>thought packets</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta charset="utf-8" />
        <!-- twitter card metadata -->
<meta name="twitter:site" content="">
<meta name="twitter:title" content=""Backup to an iSCSI share using Restic"">
<meta name="twitter:description" content="">
        <!-- OG Tags -->
<meta property="og:url" content="./backup-to-an-iscsi-share-using-restic.html"/>
<meta property="og:title" content="thought packets | "Backup to an iSCSI share using Restic"" />
<meta property="og:description" content="" />
        <!-- favicon -->
        <!-- moment.js for date formatting -->
        <script src="./theme/js/moment.js"></script>
        <!-- css -->
        <link rel="stylesheet" type="text/css" href="./theme/css/main.css" />
		<script>
			
                /*! grunt-grunticon Stylesheet Loader - v2.1.2 | https://github.com/filamentgroup/grunticon | (c) 2015 Scott Jehl, Filament Group, Inc. | MIT license. */
    
    (function(e){function t(t,n,r,o){"use strict";function a(){for(var e,n=0;u.length>n;n++)u[n].href&&u[n].href.indexOf(t)>-1&&(e=!0);e?i.media=r||"all":setTimeout(a)}var i=e.document.createElement("link"),l=n||e.document.getElementsByTagName("script")[0],u=e.document.styleSheets;return i.rel="stylesheet",i.href=t,i.media="only x",i.onload=o||null,l.parentNode.insertBefore(i,l),a(),i}var n=function(r,o){"use strict";if(r&&3===r.length){var a=e.navigator,i=e.Image,l=!(!document.createElementNS||!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect||!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")||e.opera&&-1===a.userAgent.indexOf("Chrome")||-1!==a.userAgent.indexOf("Series40")),u=new i;u.onerror=function(){n.method="png",n.href=r[2],t(r[2])},u.onload=function(){var e=1===u.width&&1===u.height,a=r[e&&l?0:e?1:2];n.method=e&&l?"svg":e?"datapng":"png",n.href=a,t(a,null,null,o)},u.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",document.documentElement.className+=" grunticon"}};n.loadCSS=t,e.grunticon=n})(this);(function(e,t){"use strict";var n=t.document,r="grunticon:",o=function(e){if(n.attachEvent?"complete"===n.readyState:"loading"!==n.readyState)e();else{var t=!1;n.addEventListener("readystatechange",function(){t||(t=!0,e())},!1)}},a=function(e){return t.document.querySelector('link[href$="'+e+'"]')},c=function(e){var t,n,o,a,c,i,u={};if(t=e.sheet,!t)return u;n=t.cssRules?t.cssRules:t.rules;for(var l=0;n.length>l;l++)o=n[l].cssText,a=r+n[l].selectorText,c=o.split(");")[0].match(/US\-ASCII\,([^"']+)/),c&&c[1]&&(i=decodeURIComponent(c[1]),u[a]=i);return u},i=function(e){var t,o,a;o="data-grunticon-embed";for(var c in e)if(a=c.slice(r.length),t=n.querySelectorAll(a+"["+o+"]"),t.length)for(var i=0;t.length>i;i++)t[i].innerHTML=e[c],t[i].style.backgroundImage="none",t[i].removeAttribute(o);return t},u=function(t){"svg"===e.method&&o(function(){i(c(a(e.href))),"function"==typeof t&&t()})};e.embedIcons=i,e.getCSS=a,e.getIcons=c,e.ready=o,e.svgLoadedCallback=u,e.embedSVG=u})(grunticon,this);
                
                grunticon(["./theme/css/icons.data.svg.css", "./theme/css/icons.data.png.css", "./theme/css/icons.fallback.css"]);
            </script>
        <noscript><link href="./theme/css/icons.fallback.css" rel="stylesheet"></noscript>
        <!-- menu toggle javascript -->
        <script type="text/javascript">
            document.addEventListener("DOMContentLoaded", initMenu);
            
            function initMenu(){
                var menu = document.getElementById("menu");
                var menulink = document.getElementById("menu-link");
                menulink.addEventListener("click", function toggleMenu(){
                        window.event.preventDefault();
                        menulink.classList.toggle('active');
                        menu.classList.toggle('active');              
                    });
            };
        </script>


    <meta name="tags" content="["Restic"" />
    <meta name="tags" content=""Backups"" />
    <meta name="tags" content=""iSCSI"" />
    <meta name="tags" content=""RHCE"]" />

</head>
<body>
    <div role="banner" id="masthead">
        <header>
            <h1><a href="/">'s Blog</a></h1>
            <a href="#menu" id="menu-link">more stuff</a>
            <nav id="menu">
                <ul>
                            <li><a href="./category/about.html">about</a></li>
                            <li><a href="./category/links.html">links</a></li>
                            <li class="active"><a href="./category/project.html">project</a></li>
                </ul>
            </nav>
        </header>
    </div>
        <div class="page" role="main">
  <div class="article" role="article">
    <article>
        <footer>
            <a name="top"></a>
            <p>
              <time datetime=" 2018-05-30 22:40:52-04:00">
                <script>document.write(moment('2018-05-30 22:40:52-04:00').format('LL'));</script>
              </time>
            </p>
        </footer>
        <header>
          <h2>
            "Backup to an iSCSI share using Restic"
          </h2>
        </header>
      <div class="content">
         <h1>Backing up with Restic over iscsi:</h1>
<h2>You do have backups, don't you?</h2>
<p>Everyone has pictures, videos, books, life memories, documents, etc, that are irreplaceable. Baby's first steps, wedding videos, memories of  that
time you went to that place and did the thing. You want these to stay with you, right? Whether production or personal, you NEED backups of your
data.</p>
<h2>Why iscsi? What's restic?</h2>
<p>I know I need a good, simple backup system. I've tried a few, but wasn't really happy with any of them, either the set-up was painful, or the
tooling was painful to use. I first learned about Restic from this <a href="https://fedoramagazine.org/use-restic-encrypted-backups/">Fedora Magazine</a> article. Reading the Restic <a href="https://restic.readthedocs.io">docs</a>_ you get lots of choices for storage backends, simple cli tools for scripting,
and an easy install. An ideal of the unix tradition is mixing and matching single-purpose tools to create useful systems and Restic lends itself well to this purpose. </p>
<p>Using iscsi with Restic isn't necessary, in fact, since the machines I am using on my LAN have ssh access to each other, iscsi is just extra complexity. It's the first thing I thought of as a project, and it is working quite well, so I plan to stick with it. Linux iscsi tools allow you to share storage from one or more machines over the network. If you are familiar with a NAS (Network Attached Storage), this is similar, but different. 
My basic understanding is that with a NAS unit, you are exposing an appliance with storage and a file system over your LAN. Linux iscsi tooling creates a SAN (Storage Area Network) that exposes block devices to properly configured clients. The iscsi client is called an "initiator", while the server is called a "target." Why target/initiator? Ummm...good question.</p>
<hr>
<h2>Ok, how do you do that? Part 1 - iscsi target</h2>
<p>The iscsi "target" or server needs a CLI tool named <strong>targetcli</strong>. On CentOS 7, this is a simple yum command.</p>
<div class="highlight"><pre><span></span>        yum -y install targetcli
</pre></div>


<p>Using targetcli is mostly straightforward, thanks to good examples in the man page and tab completion. The basic idea is as follows;</p>
<p><strong>Create or configure storage to share.</strong> This can be an actual block device/partition/LVM or a large file backstore <em>think of a swap file, but for storage, not swap space</em>.</p>
<p><code>sh
   [root@target-server ~]# targetcli
               targetcli shell version 2.1.fb46
               Copyright 2011-2013 by Datera, Inc and others.
               For help on commands, type 'help'.
               /&gt; backstores/block/ create block1 /dev/vg/lv_iscsi</code></p>
<p><strong>Create a name for your share.</strong> The name follows a sort of reverse DNS scheme, starting with the letters "iqn", and ending with a target name.</p>
<p>```sh
   /&gt; iscsi/ create iqn.2018-06.local.target-server:target1</p>
<p>Created target iqn.2018-06.local.target-server:target1.
   Created TPG 1.
   Global pref auto_add_default_portal=true
   Created default portal listening on all IPs (0.0.0.0), port 3260.
   ```</p>
<p>In this case, I am using <em>.local</em> as the lan domain and <em>.target-server</em> as the machine name. The target name you want to create must be
   separated by a colon <em>":"</em>. The first two steps result in a "target portal group", abbreviated "TPG". The target/server offers a portal to connect to backstore.</p>
<p><strong>Create a LUN (logical unit number) for the named store under the new <code>iscsi/iqn.2018-06.local.target-server:target1/tpg1</code> directory.</strong></p>
<p><code>sh
   /&gt; cd iscsi/iqn.2018-06.local.target-server:target1/tpg1
   /iscsi/iqn.2018-06.local.target-server:target1/tpg1&gt; luns/ create /backstores/block/block1</code></p>
<p><strong>Set up access for the initiator/client, known as an  ACL for the logical storage unit/</strong></p>
<p><code>sh
   /iscsi/iqn.2018-06.local.target-server:target1/tpg1&gt; acls/ create iqn.2018-06.local.target-server:client</code></p>
<p>You can set a password for the share (I didn't). Make sure to copy the acl you've just created, this goes in your initiatorname.iscsi config file on the client. As always, <code>systemd enable --now target</code> will enable the target shares on reboot.</p>
<p><strong>Remember to open the appropriate firewall port (3260/tcp)</strong></p>
<p><code>sh
   firewall-cmd --add-port=3260/tcp --permanent &amp;&amp; firewall-cmd --runtime-to-permanent</code></p>
<hr>
<h2>Ok, how do you do that? Part 2 - iscsi initiator</h2>
<p>Moving to the client (aka initiator), we also need to install a bit of tooling.</p>
<div class="highlight"><pre><span></span>       yum -y install iscsi-initiator-utils
</pre></div>


<p>This provides the <code>iscsiadm</code> command, which must be run as root or with sudo. There are three steps to connect to the shared storage on the server;</p>
<p><strong>Configure the initiatorname in <code>/etc/iscsi/initiatorname.iscsi</code></strong></p>
<p><code>sh
   [root@client.local]$ echo 'InitiatorName=iqn.2018-06.local.target-server:client' &gt;&gt; /etc/iscsi/initiatorname.iscsi</code></p>
<p><strong>Add the target server to the iscsi discovery database.</strong></p>
<p><code>sh
   [root@client.local]$ iscsiadm --mode discovery --type sendtargets --portal 0.0.0.0</code></p>
<p><em>NOTE: instead of 0.0.0.0 - use the actual IP of the server.</em></p>
<p><strong>Login to the target.</strong></p>
<p><code>sh
   [root@client.local]$ iscsiadm --mode node --name iqn.2018-06.local.target-server:target1 --portal 0.0.0.0 --login</code></p>
<p>After a successful login, you can mount the storage wherever you like and create a filesystem on it.</p>
<hr>
<h2>Ok, how do you do that? Part 3 - Restic</h2>
<p>Restic is easily installed, see the docs <a href="https://restic.readthedocs.io/en/stable/020_installation.html">here</a> for distro/os specific 
directions. I am using the iscsi share I have mounted at /opt/Backups and again, following the docs by restic, you will;</p>
<ul>
<li>Initialize a "repo" for backups</li>
<li>Create your first backup</li>
<li>Learn how to check and restore from your backups</li>
</ul>
<p>The final step I took is to schedule backups with cron (or a systemd timer), which I have done in my Ansible role for restic.</p>
<h2>And now to Ansiblize it</h2>
<p>Since Ansible isn't the primary focus of this series, I will just link to my ansible repo <a href="https://github.com/AffableZonkey/ChongoChingi.git">here</a>. Hopefully this helps you get started with iscsi and restic. Feedback is appreciated!</p>
      </div>
      <div class="back-to-top">
          <a href="#top">back to top</a>
      </div>
    </article>
  </div>
<!-- end article -->
                <footer>
                    <div class="icons">
                    </div>
                    <p>Â© <script>document.write(moment().format('YYYY'));</script> Zach Villers</p>
                </footer>
        </div>
</body>
</html>